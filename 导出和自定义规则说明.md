# 钓鱼规则导出和自定义说明

## 功能概述

本插件现在支持：
1. 从游戏导出钓鱼规则到 YAML 文件
2. 从配置文件读取自定义钓鱼规则并应用到游戏

## 使用方法

### 1. 导出游戏规则

使用管理员命令导出规则：

```bash
# 查看统计信息
/afa exportstats

# 导出规则到文件
/afa export
```

导出的文件保存在：`tshock/AutoFish/export.yml`

导出的文件包含：
- 所有完全匹配的钓鱼规则
- 每条规则的物品、概率、稀有度、触发条件
- 文件末尾的统计报告

### 2. 自定义钓鱼规则

在配置文件 `tshock/AutoFish/config.yml` 中添加自定义规则：

```yaml
customFishRules:
  - possibleItems:
      - 2002  # 蛭虫
      - 2675  # 熟手诱饵
    chanceNumerator: 1
    chanceDenominator: 10
    rarity: Common
    conditions:
      - HardMode
      - Ocean
  
  - possibleItems:
      - 3456  # 金币
    chanceNumerator: 1
    chanceDenominator: 20
    rarity: Rare
    conditions:
      - BloodMoon
      - Height1
```

### 3. 规则参数说明

**possibleItems**: 可能掉落的物品 ID 列表
- 可以包含一个或多个物品 ID
- 如果有多个，游戏会随机选择一个

**chanceNumerator**: 概率分子（默认 1）

**chanceDenominator**: 概率分母（默认 1）
- 例如：`1/10` 表示 10% 的概率

**rarity**: 稀有度（可选）
- `Any` - 任意
- `Common` - 普通
- `Uncommon` - 不常见
- `Rare` - 稀有
- `VeryRare` - 非常稀有
- `Legendary` - 传说
- `UncommonOrCommon` - 不常见或普通
- `BombRarity` - 炸弹稀有度

**conditions**: 触发条件列表（可选）

可用的钓鱼条件：
- `HardMode` - 困难模式
- `EarlyMode` - 早期模式（非困难模式）
- `InLava` - 在熔岩中
- `InHoney` - 在蜂蜜中
- `Junk` - 垃圾物品
- `Crate` - 宝箱
- `AnyEnemies` - 有敌怪生成
- `Dungeon` - 地牢（已击败骷髅王）
- `Beach` - 海滩
- `Hallow` - 神圣之地
- `GlowingMushrooms` - 发光蘑菇地
- `TrueDesert` - 真正的沙漠
- `TrueSnow` - 真正的雪地
- `Height0` - 天空
- `Height1` - 地表
- `Height2` - 地下
- `Height3` - 洞穴
- `UnderRockLayer` - 在岩石层以下
- `Corruption` - 腐化之地
- `Crimson` - 猩红之地
- `Jungle` - 丛林
- `Snow` - 雪地
- `Desert` - 沙漠
- `Ocean` - 海洋
- `BloodMoon` - 血月
- 等等...

### 4. 特殊区域和 Stopper 机制

某些特殊条件会触发 **Stopper** 机制，阻止后续规则的检查。

**默认头部 Stopper：**
- `AnyEnemies` - 如果有敌怪生成，直接停止所有规则匹配
- 这个 Stopper 会在所有自定义规则之前自动添加
- 不需要在配置中手动指定

**需要分组的特殊条件：**
以下条件会触发分组和 Stopper：
- `InLava` - 在熔岩中
- `InHoney` - 在蜂蜜中
- `Junk` - 垃圾物品
- `Crate` - 宝箱
- `Ocean` - 海洋

**工作原理：**
- 插件会自动识别包含这些特殊条件的规则
- 这些规则会被按优先级分组处理
- 每组规则加载后会自动添加一个 Stopper，阻止继续检查其他规则
- 优先级顺序：InLava > InHoney > Junk > Crate > Ocean
- 没有特殊条件的规则会最后处理

**完整的加载顺序：**
1. **AnyEnemies Stopper**（默认头部）
2. **InLava 组** → InLava Stopper
3. **InHoney 组** → InHoney Stopper
4. **Junk 组** → Junk Stopper
5. **Crate 组** → Crate Stopper
6. **Ocean 组** → Ocean Stopper
7. **普通规则组**（无特殊条件）

**示例：**
```yaml
# 这些规则包含 InLava 条件，会被分为一组，并在最后自动添加 Stopper
customFishRules:
  - possibleItems: [2315]  # 黑曜石剑鱼
    chanceNumerator: 1
    chanceDenominator: 10
    conditions:
      - InLava
  
  - possibleItems: [2312]  # 熔岩鱼
    chanceNumerator: 1
    chanceDenominator: 5
    conditions:
      - InLava
  # 自动添加 InLava 的 Stopper
```

### 5. 重载配置

修改配置后，使用以下命令重载：

```bash
/reload
```

重载时会自动加载自定义规则，控制台会显示：
- 加载的规则数量
- 为哪些特殊条件添加了 Stopper

## 工作流程示例

1. 导出游戏规则作为参考：
   ```bash
   /afa export
   ```

2. 打开 `export.yml` 查看规则格式

3. 在 `config.yml` 中添加自定义规则

4. 重载配置：
   ```bash
   /reload
   ```

5. 测试自定义规则是否生效

## 注意事项

- 自定义规则的加载顺序：
  1. 先处理包含特殊条件（AnyEnemies、InLava等）的规则
  2. 按优先级分组，每组后自动添加 Stopper
  3. 最后处理没有特殊条件的普通规则
- 条件和稀有度字符串不区分大小写
- 如果某个条件无法识别，会被跳过并在日志中记录
- 导出功能只导出完全匹配的规则（所有条件都能映射）
- 部分匹配的规则会被跳过，但会在统计中显示

## 故障排除

如果自定义规则不生效：
1. 检查控制台日志是否有错误信息
2. 确认 YAML 格式正确（缩进、冒号、短横线）
3. 确认物品 ID 和条件名称正确
4. 使用 `/afa exportstats` 查看统计信息
5. 检查是否有特殊条件导致 Stopper 被触发
